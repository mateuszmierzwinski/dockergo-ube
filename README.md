# Docker Go Universal Build Environment (DockerGo-UBE)

This repository holds image of docker that can build Go applications without actually installing GO environment on local PC.
It's suitable also to be running on Bamboo/Jenkins.

### Projects Makefile

To build GO application please use this Makefile. You can trigger build by running "make".

```
# Update project name here. It should be called as your app root
PROJECT_NAME=servicename

# Do not edit below this line
ROOT_DIR:=$(shell dirname $(realpath $(lastword $(MAKEFILE_LIST))))/../
PROJECT_PATH=/go/src/$(PROJECT_NAME)/
ORIG_PATH=/app/$(PROJECT_NAME)/

default:
	@echo Dockerized build
	@sudo docker run -it --volume-driver overlay2 -v $(ROOT_DIR):/app mateuszmierzwinski/dockergo-ube:latest make -f $(ORIG_PATH)/Makefile indocker

indocker: prepare mocks tests benchmark build

prepare:
	@echo Preparition
	@cp -r /app/$(PROJECT_NAME) /go/src/
	@rm -fR $(ORIG_PATH)target
	@mkdir $(ORIG_PATH)target
	@cd $(PROJECT_PATH) && dep ensure

mocks:
	@echo Mocks
	@cd $(PROJECT_PATH) && go generate mocks.go

tests:
	@echo Tests
	@cd $(PROJECT_PATH) && go test -cover -coverprofile=$(ORIG_PATH)target/coverage.out .

benchmark:
	@echo Benchmark
	@cd $(PROJECT_PATH) && go test -bench=. -run=5000 -cpuprofile=$(ORIG_PATH)target/cpuprofile.out -memprofile=$(ORIG_PATH)target/memoutprofile.out
	@echo Processing results
	@cd $(PROJECT_PATH) && go tool pprof -pdf $(ORIG_PATH)target/cpuprofile.out > $(ORIG_PATH)target/benchmark_results.pdf

build:
	@echo Build
	@cd $(PROJECT_PATH) && go build -o $(ORIG_PATH)target/$(PROJECT_NAME)-std .
	@cd $(PROJECT_PATH) && go build -o $(ORIG_PATH)target/$(PROJECT_NAME)-prod -ldflags="-s -w" .
	@echo Done. Stored in target directory
```

### Depedencies

This image contains dependencies management with DEP. If you did not used it before please check github account of DEP.
Mocking framework embedded into image is GoMock. Mockgen is included in image.

### Output and artifacts

After running this makefile output should be put in target directory inside of your application source code.

Please include this directory in your .gitignore file.

Output of this script is application, prod version stripped from symbols and DWARF, coverage.out statistics (for SonarQube), profiling of CPU and Memory and PDF schema generated by benchmarking.

### License

This repository content is shared under GPL license. No Warranty of anykind usage provided. No responsibility taken.